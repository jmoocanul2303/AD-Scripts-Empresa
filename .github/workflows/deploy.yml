name: Despliegue Scripts AD

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    # 1. Descargar el código en el servidor
    - name: Chequear Código
      uses: actions/checkout@v4

    # 2. Revisar que no haya errores de escritura (Sintaxis)
    - name: Analizar Sintaxis (Linting)
      run: |
        # Si encuentra errores graves, detiene el proceso
        Invoke-ScriptAnalyzer -Path .\*.ps1 -Severity Error -ErrorAction Stop
      shell: powershell

    # 3. Ejecutar Pruebas (Solo si existen archivos de prueba)
    - name: Ejecutar Pruebas Pester
      run: |
        if (Test-Path ".\*.Tests.ps1") {
            $resultado = Invoke-Pester -Path .\*.Tests.ps1 -PassThru
            if ($resultado.FailedCount -gt 0) { throw "Las pruebas fallaron. Cancelando despliegue." }
        } else {
            Write-Host "No se encontraron archivos de prueba (.Tests.ps1). Continuando..."
        }
      shell: powershell

    # 4. Copiar los archivos a la carpeta final
    - name: Desplegar a Producción
      run: |
        # Rutas definidas
        $origen = "$env:GITHUB_WORKSPACE\*.ps1"
        $destino = "C:\Produccion\" 

        # Crear la carpeta si por alguna razón no existe
        if (-not (Test-Path -Path $destino)) {
            New-Item -ItemType Directory -Path $destino -Force
            Write-Host "Se creó la carpeta $destino"
        }
        
        Write-Host "Iniciando copia de archivos..."
        
        # Copiar archivos .ps1 forzando la sobreescritura
        Copy-Item -Path $origen -Destination $destino -Force
        
        Write-Host "¡ÉXITO! Archivos copiados en $destino"
      shell: powershell